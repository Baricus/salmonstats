# Github Workflow
# Creates a draft release whenever a tag with v* is added

name: generate_draft_release

on:
  push:
    tags:  
      - "v*"

permissions:
  contents: write

jobs:
  make-artifacts:
    name: Build artifacts
    uses: ./.github/workflows/build.yml
    with:
      upload-artifacts: true

  make-release:
    needs: make-artifacts
    name: Consolidate and upload
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v3

      - name: List artifacts
        run: ls -R artifacts/

      - name: Strip binaries
        run: |
          strip artifacts/Linux/out/salmonstats
          strip artifacts/macOS/out/salmonstats
          strip artifacts/Windows/out/salmonstats

      - name: Create Release
        uses: ncipollo/release-action@v1.12.0
        with:
          draft: true
          artifacts: artifacts/*/*, CHANGELOG.md
          body: "AUTOGENERATED: FILL BEFORE RELEASE"
