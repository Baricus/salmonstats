# Github Workflow
# Creates a draft release whenever a tag with v* is added

name: generate_draft_release

on:
  push:
    branches: [main, release/*]
    tags:  
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  make-artifacts:
    name: Build artifacts
    uses: ./.github/workflows/build.yml
    with:
      upload-artifacts: true

  make-release:
    needs: make-artifacts
    name: Consolidate and upload
    runs-on: ubuntu-latest

    steps:
      - name: download artifacts
        uses: actions/download-artifact@v3

      - name: Strip binaries
        run: |
          strip artifacts/ubuntu-latest/salmonstats
          strip artifacts/windows-latest/salmonstats
          strip artifacts/macos-latest/salmonstats

      - name: Create Release
        uses: ncipollo/release-action@v1.12.0
        with:
          draft: true
          artifacts: artifacts/*/*
          body: "AUTOGENERATED: FILL BEFORE RELEASE"
